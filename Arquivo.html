<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emulação de Lentes Adaptável</title>
  <style>
    canvas { display: block; margin: auto; background: #000; }
    button, label, select { display: block; margin: 20px auto; text-align: center; }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline style="display:none;"></video>
  <canvas id="glCanvas" width="480" height="640"></canvas>
  <label for="focalLengthSelect">Distância Focal (mm):</label>
  <select id="focalLengthSelect">
    <option value="35">35mm</option>
    <option value="50" selected>50mm</option>
    <option value="85">85mm</option>
    <option value="135">135mm</option>
  </select>
  <label for="apertureSelect">Abertura:</label>
  <select id="apertureSelect">
    <option value="1.4">f/1.4</option>
    <option value="1.8">f/1.8</option>
    <option value="2.8">f/2.8</option>
    <option value="16">f/16</option>
    <option value="22" selected>f/22</option>
  </select>
  <button id="saveButton">Salvar Imagem</button>
  <script>const canvas=document.getElementById("glCanvas"),gl=canvas.getContext("webgl");if(!gl){alert("Seu navegador não suporta WebGL!");throw new Error("WebGL não é suportado.")}const vertexShaderSource=`attribute vec2 a_position; varying vec2 v_texCoord; void main() { vec2 pos = a_position; v_texCoord = pos * 0.5 + 0.5; gl_Position = vec4(pos, 0, 1); }`,fragmentShaderSource=`precision mediump float; varying vec2 v_texCoord; uniform sampler2D u_image; uniform vec2 u_focusPoint; uniform float u_apertureSize; uniform float u_focalLength; uniform vec2 u_canvasResolution; float calculateDepthBlur(vec2 uv, vec2 focusPoint, float apertureSize, float focalLength, float focusDist) { float planeDist = focalLength * (1.0 + focalLength / (focusDist - focalLength)); float coc = abs((length(uv - focusPoint) * planeDist) / (apertureSize * 0.01 * u_canvasResolution.y)); return smoothstep(0.0, 0.03, coc); } vec2 applyLensDistortion(vec2 uv, float focalLength, vec2 canvasResolution) { vec2 centeredUV = uv - 0.5; centeredUV *= canvasResolution / min(canvasResolution.x, canvasResolution.y); float r = length(centeredUV); centeredUV += centeredUV * (r * r) / focalLength; return centeredUV + 0.5; } vec4 simulateRefractiveCoating(vec4 color, vec2 uv, vec2 canvasResolution) { float vignette = pow(1.0 - length((uv - 0.5) * canvasResolution / max(canvasResolution.x, canvasResolution.y)), 2.0); return color * vec4(vignette, vignette, vignette, 1.0); } void main() { vec2 adjustedUV = vec2(v_texCoord.x, 1.0 - v_texCoord.y); adjustedUV = applyLensDistortion(adjustedUV, u_focalLength, u_canvasResolution); float blurAmount = calculateDepthBlur(adjustedUV, u_focusPoint, u_apertureSize, u_focalLength, 0.45); vec4 color = texture2D(u_image, mix(adjustedUV, u_focusPoint, blurAmount)); color = simulateRefractiveCoating(color, adjustedUV, u_canvasResolution); gl_FragColor = color; }`;function createShader(a,b,c){const d=a.createShader(b);return a.shaderSource(d,c),a.compileShader(d),a.getShaderParameter(d,a.COMPILE_STATUS)?d:(console.error(a.getShaderInfoLog(d)),a.deleteShader(d),null)}function createProgram(a,b,c){const d=a.createProgram();return a.attachShader(d,b),a.attachShader(d,c),a.linkProgram(d),a.getProgramParameter(d,a.LINK_STATUS)?d:(console.error(a.getProgramInfoLog(d)),a.deleteProgram(d),null)}const vertexShader=createShader(gl,gl.VERTEX_SHADER,vertexShaderSource),fragmentShader=createShader(gl,gl.FRAGMENT_SHADER,fragmentShaderSource),program=createProgram(gl,vertexShader,fragmentShader),positionBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,positionBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),gl.STATIC_DRAW);const positionAttributeLocation=gl.getAttribLocation(program,"a_position");gl.enableVertexAttribArray(positionAttributeLocation),gl.vertexAttribPointer(positionAttributeLocation,2,gl.FLOAT,!1,0,0);const texture=gl.createTexture(),video=document.getElementById("video");navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(a=>{video.srcObject=a,video.onloadedmetadata=()=>{video.play(),gl.bindTexture(gl.TEXTURE_2D,texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,video),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),render()}}).catch(a=>{console.error("Erro ao acessar a câmera:",a)});const focalLengthSelect=document.getElementById("focalLengthSelect"),apertureSelect=document.getElementById("apertureSelect"),focusPointLocation=gl.getUniformLocation(program,"u_focusPoint"),apertureSizeLocation=gl.getUniformLocation(program,"u_apertureSize"),focalLengthLocation=gl.getUniformLocation(program,"u_focalLength"),canvasResolutionLocation=gl.getUniformLocation(program,"u_canvasResolution");let focusPoint={x:0.5,y:0.5},apertureSize=parseFloat(apertureSelect.value),focalLength=parseFloat(focalLengthSelect.value);apertureSelect.addEventListener("change",()=>{apertureSize=parseFloat(apertureSelect.value)});focalLengthSelect.addEventListener("change",()=>{focalLength=parseFloat(focalLengthSelect.value)});const render=()=>{gl.useProgram(program),gl.uniform2f(focusPointLocation,focusPoint.x,focusPoint.y),gl.uniform1f(apertureSizeLocation,apertureSize),gl.uniform1f(focalLengthLocation,focalLength),gl.uniform2f(canvasResolutionLocation,canvas.width,canvas.height),gl.clearColor(0,0,0,1),gl.clear(gl.COLOR_BUFFER_BIT),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,video),gl.drawArrays(gl.TRIANGLE_STRIP,0,4),requestAnimationFrame(render)};document.getElementById("saveButton").addEventListener("click",()=>{render();const a=document.createElement("a");a.download="saida.jpg",a.href=canvas.toDataURL("image/jpeg"),a.click()}),render();</script>
</body>
</html>
